"Fix the entire identity + onboarding + profile pipeline so it is permanent and stable. Make the following changes across userProfile.js, useUserStore.js, progressStore.js, and App.jsx. Do not change UI or styles. Just fix logic. Apply all steps cleanly:

1. PROFILE CREATION (userProfile.js)
A. Insert avatar as TEXT, not number

Default avatar must be "avatar_man_lantern" or "avatar_boy_lantern" (string), not 0.

Ensure insert() and update() always use avatar string keys, matching Supabase schema (avatar: text).

B. Ensure only ONE profile creation call happens

Move ensureProfile() so it only runs once, after:

silent auth restored

deviceId ready

before any store loads (progress/daily/challenges)

C. Never overwrite an existing profile with null fields

When updating cloud profile:

Only send fields that are non-null.

Never send undefined/null username/avatar/handle.

If a field is null in local state, DO NOT include it in update payload.

2. ONBOARDING FLOW (useUserStore.js)
A. Always require onboarding unless cloud row has username + avatar

If Supabase returns profile but username OR avatar is null:

Reset hasOnboarded = false

Reset step = 0

Trigger full onboarding flow again (Bismillah → Salaam → Name → Avatar → Username)

B. When onboarding finishes:

setOnboarded(true) only AFTER:

username chosen

avatar chosen

handle chosen

saveProfile() successfully updates Supabase

C. saveProfile()

Must ONLY update:

username

avatar

handle

Must NEVER update xp, streak, coins, shield_count.

Must NEVER sync null values.

3. PROGRESS STORE FIX (progressStore.js)
A. Prevent overwriting username / avatar

Remove or modify lines that sync username/avatar from progressStore.

Progress store should ONLY sync:

xp

coins

streak

shield_count

daily quest data

revision data

Identity fields (username/avatar/handle) must NEVER be touched here.

B. Ensure progress sync does not run until AFTER profile is fully loaded

Add guard: if profile not ready, skip cloud sync.

4. APP INITIALISATION (App.jsx)
A. Ensure sequence is:

silentAuth()

load deviceId

ensureProfile() → only once

loadCloudProfile()

THEN load progressStore/dailyQuestStore/etc.

If profile.username/avatar missing → onboarding

If hasOnboarded false → show onboarding screens

After onboarding → go Home instantly

B. Remove ANY duplicate calls to ensureProfile() to prevent double inserts.
5. CLEANUP LOGIC
A. If cloud profile fields are null:

Clear corrupted local onboarding state

Force full onboarding

Never allow a half-complete profile row to pass

B. Add safe logging (no spamming):

Log only:

“PROFILE CREATED”

“PROFILE UPDATED”

“ONBOARDING REQUIRED”

“ONBOARDING COMPLETE”

6. DO NOT CHANGE:

UI layouts

Colors

Navigation appearance

File structure

Any challenge/event logic

Existing Supabase table schema

✔ Make all these changes now.
✔ Ensure all screens still behave exactly the same visually.
✔ Ensure Supabase always receives complete profiles with username + avatar.
✔ Ensure onboarding can never be skipped incorrectly.
✔ Ensure profile creation happens once and never duplicates.
✔ Ensure progress store never overwrites identity fields again.

After applying the fixes, print a summary of what was updated."
AUDIT & HARDEN IAP ENTITLEMENT FLOW — ZERO GUESSWORK

Context:
Google Play Billing CONFIRMS ownership:
queryPurchases(INAPP) returns owned item:
productId = "premium_lifetime"

Problem:
Purchase is detected but premium is NOT unlocked.
This is the 4th iteration — exhaust ALL post-purchase failure modes.

STRICT RULES:
- Do NOT change architecture
- Do NOT touch billing setup, SKUs, or Play Console config
- Do NOT add new abstractions
- Only fix entitlement activation + persistence
- Be explicit and defensive

PRIMARY FIX (MANDATORY):
When an owned NON-CONSUMABLE is detected (premium_lifetime),
the app MUST deterministically unlock premium.

Implement this invariant:
"IF store reports owned → premium = true everywhere"

REQUIRED CHECKS & FIXES (ALL):

1) RESTORE PATH COMPLETION
- Verify restorePurchases() AND silentAutoRestore()
  both call the SAME entitlement activation function.
- Ensure owned products do NOT stop at logging.
- Force entitlement activation immediately.

2) ENTITLEMENT ACTIVATION
When owned product is detected:
- Set local premium state = true (React state / store)
- Persist to storage (cache / secure storage if used)
- Trigger backend sync (verifyReceipt OR direct Supabase update)
- UI must update without restart

Add log:
"[IAP] PREMIUM ENTITLEMENT ACTIVATED FROM RESTORE"

3) BACKEND SYNC FAILURE SAFETY
- If Supabase / verifyReceipt fails:
  - STILL unlock premium locally
  - Log backend failure but do NOT block entitlement
(Store is source of truth)

4) ACKNOWLEDGEMENT / FINALIZATION
- Ensure non-consumable is acknowledged if required
- Do NOT consume
- Do NOT block unlock on acknowledgement status

5) STATE OVERRIDES & REGRESSIONS
Check for ANY code that can re-lock premium:
- auth refresh
- profile fetch
- user reload
- app resume
- Supabase profile overwrite
If found:
- Backend premium must override defaults
- Owned store entitlement must override backend false

6) SKU FILTERING / LOOP LOGIC
- Ensure product loops do NOT exit early
- Ensure comparisons are strict (=== "premium_lifetime")
- Ensure platform-specific IDs are not mismatched at restore time

7) UI GATING
- Verify paywall visibility logic reacts to premium state change
- Ensure modal does NOT auto-close without unlock
- Ensure navigation guards respect premium immediately

8) ONE SOURCE OF TRUTH
Create (or reuse) ONE function:
activatePremiumEntitlement(source)
Sources: "purchase" | "restore" | "auto-restore"
ALL paths must call this.

FINAL VERIFICATION:
Add ONE summary log at app idle:
"[IAP] FINAL PREMIUM STATE = true/false (source: X)"

Deliverable:
- Minimal code changes
- Explicit explanation of which failure(s) were fixed
- Confirmation that NO other rebuild should be required

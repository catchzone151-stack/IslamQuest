PHASE 3 â€” ANALYTICS & LOGGING SYSTEM
(Only create if NOT already present in my project)

Before doing ANYTHING:
ðŸ‘‰ Check if my project already contains an analytics/logging table, edge function, or logging structure.

If an analytics system already exists:

Do NOT rebuild it

Do NOT create duplicates

Do NOT rename tables

Do NOT modify existing analytics

Only extend it slightly if needed to support the required events (never overwrite)


If NO analytics system exists:

Proceed with the steps below and build the system from scratch.


---

ðŸ”¥ SECTION 1 â€” Create analytics_events Table (ONLY IF NOT ALREADY EXISTS)

If no analytics table exists, create:

analytics_events

Fields:

id (uuid, primary key)
user_id (uuid, nullable)
event_type (text)
event_details (jsonb)
device_id (text, hashed)
platform (text)
created_at (timestamp, default now())

If a similar table already exists, reuse it instead of creating a new one.


---

ðŸ”¥ SECTION 2 â€” Add/Verify RLS Policies (ONLY IF NOT ALREADY APPLIED)

Rules:

Only service role / admin can SELECT

Only edge functions can INSERT

No user should ever see analytics

Users cannot read or modify any analytics rows


If correct RLS policies already exist, leave them untouched.


---

ðŸ”¥ SECTION 3 â€” Analytics Logging Edge Function (ONLY IF THERE ISNâ€™T ONE ALREADY)

Check if there is an existing function like:

logEvent

insertAnalyticsEvent

trackEvent

anything similar


If none exist, create:

Edge Function: logEvent

Accepts:

event_type
user_id
device_id (hashed)
platform
event_details (json)

Inserts into analytics_events.

If something similar already exists:

Do NOT replace it

Simply add any missing fields or event types



---

ðŸ”¥ SECTION 4 â€” Log These Events (ONLY IF NOT ALREADY LOGGED)

Check the project to see what events are already tracked.
If they are already being logged â†’ do nothing.
If they are missing â†’ add them.

REQUIRED purchase flow events:

purchase_initiated

purchase_token_received

purchase_verified_server

purchase_refunded

purchase_revoked

restore_purchases_attempted

restore_purchases_success

restore_purchases_failed


REQUIRED family plan events:

family_invite_sent

family_invite_link_opened

family_invite_accepted

family_invite_failed

family_limit_reached


REQUIRED device/auth events:

login_success

login_failed

active_device_changed

device_limit_triggered

logout


REQUIRED security events:

receipt_replay_blocked

invalid_receipt

refunded_receipt_detected


REQUIRED error events:

network_error

supabase_error

unknown_error


Only add events that are truly missing.
Do NOT duplicate or rename existing ones.


---

ðŸ”¥ SECTION 5 â€” Integrate Logging Into Existing Edge Functions (ONLY IF NOT ALREADY DONE)

For each edge function from Phase 1:

verifyAppleReceipt

verifyGoogleReceipt

appleWebhook

googleWebhook

restore purchases

device limit enforcement

invite acceptance


Check first:
If events are already logged â†’ do NOTHING
If events are NOT logged â†’ add logEvent calls


---

ðŸ”¥ SECTION 6 â€” DO NOT Modify Anything Else

Do NOT touch IAP logic

Do NOT modify UI

Do NOT modify premium logic

Do NOT modify family plan structure

Do NOT touch Phase 1 or Phase 2 systems

Only add analytics IF missing

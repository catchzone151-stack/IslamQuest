You must now perform a targeted fix for two missing analytics integrations in my project.

GOAL:
Fix execution of:
1. lesson_progress logging (start, exit, complete)
2. daily leaderboard snapshot triggering

IMPORTANT:
Do NOT restructure files.
Do NOT rename anything.
Only inject missing logic.

STEP 1 — Locate the root file that actually mounts the app
You must search the project for whichever file contains:
- <Router> or <Routes>
- the app wrapper (ScreenWrapper, NavigationContainer, etc)
- the top-level useEffect blocks
It may be App.jsx, main.jsx, index.jsx, or a wrapper under screens/pages.

When you find the true root file:
→ Add the daily snapshot useEffect there.
This block must run exactly once on app load.

Insert:

import { createDailyLeaderboardSnapshot } from "./backend/leaderboardSnapshots";
import { supabase } from "./supabaseClient";

useEffect(() => {
  const runDailySnapshot = async () => {
    const lastRun = localStorage.getItem("last_snapshot_run");
    const today = new Date().toDateString();
    if (lastRun !== today) {
      await createDailyLeaderboardSnapshot();
      localStorage.setItem("last_snapshot_run", today);
    }
  };
  runDailySnapshot();
}, []);

Use correct relative paths based on file location.

STEP 2 — Identify which file is actually used as the lesson screen 
It will be the file that receives the lesson object passed from Pathway or Home.
Often named Lesson.jsx, but if not, FIND the file that displays lesson content.

In that file:
- Confirm the useEffect for logLessonStart and logLessonExit exists.
- If it exists but is NOT firing, FIX the import paths and FIX the lesson.id reference.

You must ensure:

import { logLessonStart, logLessonExit, logLessonComplete } from "../backend/lessonProgress";
import { supabase } from "../supabaseClient";

Add inside component:

useEffect(() => {
  let userIdRef = null;
  const loadUser = async () => {
    const { data } = await supabase.auth.getUser();
    userIdRef = data?.user?.id;
    if (userIdRef && lesson?.id) {
      logLessonStart(userIdRef, lesson.id);
    }
  };
  loadUser();
  return () => {
    if (userIdRef && lesson?.id) {
      logLessonExit(userIdRef, lesson.id);
    }
  };
}, [lesson]);

STEP 3 — Patch QuizScreen so that lesson completion ALWAYS logs

Find the block where the quiz is finalized.
Immediately before XP is awarded insert:

await logLessonComplete(userId, currentLessonId, finalAccuracy, mistakesList);

Ensure the correct variables are used.

STEP 4 — Verify execution
After applying these patches:
- The first lesson you open must create 1–2 rows in lesson_progress.
- Completing the lesson creates another row.
- Relaunching the app creates a new row in leaderboard_snapshots.

STEP 5 — Report completion
When done, output:
"Lesson progress logging and daily snapshot trigger fully repaired."

Do not modify any other system.
